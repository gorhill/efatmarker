/*!

Project
=======

Author: Raymond Hill
Home: https://github.com/gorhill/efatmarker
Version: 1.0

License
=======

http://opensource.org/licenses/MIT

**/
(function(){var a=function(){var d=document.querySelector(".efm-target");
if(!d){throw"EFatMarker: no element with class 'efm-target' found."}this.parentNode=d;
var e=[],f=0,g=d.childNodes.length,h,k=0,j=[],c,i,b;for(;;){while(f<g){c=d.childNodes[f];
f+=1;if(c.nodeType===3){e.push({i:k,n:c});h=c.nodeValue;k+=h.length}else{if(c.nodeType===1){i=c.childNodes.length;
if(i){j.push({n:d,l:g,i:f});d=c;g=i;f=0}}}}if(!j.length){break}b=j.pop();d=b.n;g=b.l;
f=b.i}e.push({i:k});this.textmap=e;this.textLength=k;this.spans=[];this.base64Digits="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";
this.tokenToSpans=function(){var p=window.location.hash||"",r;r=p.match(/^#efm(([\-\w]{6}){1,})/);
if(!r||!r.length){return}p=r[1];this.spans=[];var q=this.base64Digits,o,t,s,l,m;for(o=0,t=p.length;
o<t;o+=6){m=p.substr(o,6);s=(q.indexOf(m.charAt(0))<<12)+(q.indexOf(m.charAt(1))<<6)+q.indexOf(m.charAt(2));
l=(q.indexOf(m.charAt(3))<<12)+(q.indexOf(m.charAt(4))<<6)+q.indexOf(m.charAt(5));
this.addSpan(s,l)}};this.spansToToken=function(){var s=this.spans.length;if(!s){return"#efm"
}var q=this.base64Digits,o=["#efm"],m,p,r,l;for(m=0;m<s;m++){p=this.spans[m];r=p.start;
l=p.end;o.push(String(q[r>>12&63])+String(q[r>>6&63])+String(q[r&63]));o.push(String(q[l>>12&63])+String(q[l>>6&63])+String(q[l&63]))
}return o.join("")};this.addSpan=function(l,o){if(l>o){var p=l;l=o;o=p}l=Math.max(0,l);
o=Math.min(this.textLength,o);if(l===o){return}var s=this.spans,m=s.length,q,t,r=0,u=m;
while(r<u){q=r+u>>1;if(o<s[q].start){u=q}else{if(l>s[q].end){r=q+1}else{u=q}}}while(u<m){t=s[u];
if(t.start>o){break}l=Math.min(t.start,l);o=Math.max(t.end,o);u++}s.splice(r,u-r,{start:l,end:o})
};this.removeSpans=function(l,o){if(l>o){var p=l;l=o;o=p}l=Math.max(0,l);o=Math.min(this.textLength,o);
if(l===o){return}var s=this.spans,m=s.length,q,u,r=0,v=m;while(r<v){q=r+v>>1;if(o<=s[q].start){v=q
}else{if(l>=s[q].end){r=q+1}else{v=q}}}var w,t;while(v<m){u=s[v];if(u.start>o){break
}w=Math.max(u.start,l);t=Math.min(u.end,o);if(w>u.start&&t<u.end){s.splice(v+1,0,{start:t,end:u.end});
u.end=w;v+=2;m++}else{if(w===u.start&&t<u.end){u.start=t;v++}else{if(w>u.start&&t===u.end){u.end=w;
v++}else{s.splice(v,1);m--}}}}};this.unhighlightAll=function(m){this.spans=[];if(m){if(window.getSelection){var l=window.getSelection();
if(l){window.getSelection().removeAllRanges()}}this.syncDOMAll()}};this.spanInSpan=function(p,l){var n=this.spans,m=n.length,o;
while(m-->0){o=n[m];if(p>=o.start&&l<=o.end){return true}}return false};this.hasSpans=function(){return this.spans.length>0
};this.highlightSelection=function(p){if(!window.getSelection){return}var o=window.getSelection();
if(!o){return}var n,m,l,q;for(n=0;n<o.rangeCount;n++){m=o.getRangeAt(n);l=this.normalizeOffset(m.startContainer,m.startOffset);
q=this.normalizeOffset(m.endContainer,m.endOffset);if(l>=0&&l<q){this.addSpan(l,q)
}}if(p){o.removeAllRanges();this.syncDOMAll()}};this.unhighlightSelection=function(p){if(!window.getSelection){return
}var o=window.getSelection();if(!o){return}var n,m,l,q;for(n=0;n<o.rangeCount;n++){m=o.getRangeAt(n);
l=this.normalizeOffset(m.startContainer,m.startOffset);q=this.normalizeOffset(m.endContainer,m.endOffset);
if(l>=0&&l<q){this.removeSpans(l,q)}}if(p){o.removeAllRanges();this.syncDOMAll()}};
this.interpretSelection=function(p){if(!window.getSelection){return}var o=window.getSelection();
if(!o){return}var n,m,l,q;for(n=0;n<o.rangeCount;n++){m=o.getRangeAt(n);l=this.normalizeOffset(m.startContainer,m.startOffset);
q=this.normalizeOffset(m.endContainer,m.endOffset);if(l>=0&&l<q){if(this.spanInSpan(l,q)){this.removeSpans(l,q)
}else{this.addSpan(l,q)}}}if(p){o.removeAllRanges();this.syncDOMAll()}};this.syncDOMAll=function(){this.syncDOMHighlights();
this.syncDOMHash();this.syncDOMMenu()};this.syncDOMHighlights=function(){this.unrender();
this.render()};this.syncDOMHash=function(){var l=this.spansToToken();window.location.hash=l
};this.syncDOMGotoFirstAnchor=function(){if(this.hasSpans()){var l=document.querySelector(".efm-parent");
if(l){var m=this.spansToToken();l.id=m.substr(1);window.location.hash="#efm";window.location.hash=m
}}};this.syncDOMMenu=function(){var p=document.getElementById("efm-permalink"),m=window.location.href,s=this.spansToToken();
if(p){p.href=m;p.innerHTML=s?"Permalink with highlights:<br><i>[...]</i>"+s.replace(/^#efm(.{3,10}).+?(.{3,10})$/,"$1...$2"):"Permalink: [no highlights]"
}p=document.getElementById("efm-twitter-button");if(p){var q=[];q.push("url="+String(encodeURIComponent(m)));
var l=[document.querySelector("head title").innerHTML.replace(/_.*$/,""),"#wlfind"];
q.push("text="+encodeURIComponent(l.join(" ")));q.push("related=wikileaks");var u=document.querySelector('head link[rel="canonical"]');
if(u){q.push("counturl="+String(encodeURIComponent(u.href)))}p.href="https://twitter.com/share?"+q.join("&")
}var o=document.querySelectorAll(".efm-need-highlight"),r=o.length,t=this.hasSpans();
while(r--){o[r].style.display=t?"":"none"}};this.unrender=function(){var m=this.textmap,l=m.length-1,o,p,n;
while(l-->0){o=m[l];p=o.n.parentNode;if(p&&p.className&&p.className==="efm-hi"){p.parentNode.replaceChild(o.n,p)
}}l=m.length-1;while(l-->0){o=m[l];n=o.n.parentNode;if(p&&p.className&&n.className==="efm-parent"){while(n.hasChildNodes()){n.parentNode.insertBefore(n.firstChild,n)
}n.parentNode.removeChild(n)}}};this.render=function(){var m=this.spans,l=m.length,n;
while(l-->0){n=m[l];this.renderSpan(n.start,n.end)}};this.renderSpan=function(A,p){var n=this.textmap,q,s,z,x,y,l,t,r,v,o,w,m,u;
s=0;z=n.length;while(s<z){q=s+z>>1;if(A<n[q].i){z=q}else{if(A>=n[q+1].i){s=q+1}else{s=z=q
}}}x=s;z=n.length;while(x<z){y=n[x];l=y.i;t=y.n.nodeValue;v=A-l;o=Math.min(p,n[x+1].i)-l;
n.splice(x,1);w=document.createElement("span");w.className="efm-parent";if(v>0){u=document.createTextNode(t.substring(0,v));
w.appendChild(u);n.splice(x,0,{i:l,n:u});l+=u.length;x++}m=document.createElement("span");
u=document.createTextNode(t.substring(v,o));m.appendChild(u);m.className="efm-hi";
w.appendChild(m);n.splice(x,0,{i:l,n:u});l+=u.length;x++;if(o<t.length){u=document.createTextNode(t.substr(o));
w.appendChild(u);n.splice(x,0,{i:l,n:u});l+=u.length;x++}y.n.parentNode.replaceChild(w,y.n);
if(p<=n[x].i){break}}};this.getTextNodes=function(){};this.normalizeOffset=function(q,p){if(q.nodeType!==3){return -1
}var n=q;while(n){n=n.parentNode;if(n===this.parentNode){break}}if(!n){return -1}var l=this.textmap,o=l.length,m;
while(o-->0){m=l[o];if(q===m.n){return m.i+p}}return -1}};window.addEventListener("load",function(){var f=new a();
if(!f){return}f.tokenToSpans();var e=document.querySelector(".efm-button-container");
if(!e){e=document.body}var g=document.createElement("div");g.id="efm-button";g.innerHTML='<div id="efm-menu"><h3 style="margin:0 0 2px 0">EFatMarker</h3><a id="efm-permalink" class="efm-need-highlight" href="#" style="margin-bottom:0;padding-bottom:0;"></a><p style="margin-top:0;padding-top:0" class="efm-need-highlight">Right-click to copy permalink.</p><a id="efm-twitter-button" class="efm-need-highlight" href="#" target="_blank">these highlights</a><p style="margin:0.5em 0;padding:0;border-top:1px dotted #ccc;height:1px"></p><a id="efm-unhighlightall" class="efm-need-highlight">Un-highlight all</a><a id="efm-unhighlight">Un-highlight selection<span>u</span></a><a id="efm-highlight">Highlight selection<span>h</span></a></div>';
e.appendChild(g);g.addEventListener("mousedown",function(h){f.interpretSelection(true);
h.preventDefault()});var d=document.querySelector("#efm-unhighlightall");if(d){d.addEventListener("mousedown",function(h){f.unhighlightAll(true);
h.preventDefault()})}d=document.querySelector("#efm-unhighlight");if(d){d.addEventListener("mousedown",function(h){f.unhighlightSelection(true);
h.preventDefault()})}d=document.querySelector("#efm-highlight");if(d){d.addEventListener("mousedown",function(h){f.highlightSelection(true);
h.preventDefault()})}d=document.querySelector("#efm-permalink");if(d){d.addEventListener("mousedown",function(h){window.location.href=this.href;
h.preventDefault()})}f.syncDOMHighlights();f.syncDOMMenu();if(f.hasSpans()){if(typeof jQuery==="function"){jQuery("body").animate({scrollTop:parseInt(jQuery(".efm-parent").offset().top,10)})
}else{if(typeof Fx==="function"){var c=document.querySelector(".efm-parent");if(c){var b=new Fx.Scroll(window,{offset:{x:0,y:-50}});
b.toElement(c)}}else{f.syncDOMGotoFirstAnchor()}}}})}());
