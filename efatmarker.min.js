/*!

Project
=======

* Author: Raymond Hill
* Home: https://github.com/gorhill/efatmarker
* Version: 1.0

License
=======

Copyright (C) 2013 Raymond Hill

http://opensource.org/licenses/MIT

**/
(function(){var c=window,b=c.document;
var a=function(){var f=b.querySelector(".efm-target");if(!f){throw"EFatMarker: no element with class 'efm-target' found."
}this.parentNode=f;var g=[],h=0,i=f.childNodes.length,j,m=0,l=[],e,k,d;for(;;){while(h<i){e=f.childNodes[h];
h+=1;if(e.nodeType===3){g.push({i:m,n:e});j=e.nodeValue;m+=j.length}else{if(e.nodeType===1){k=e.childNodes.length;
if(k){l.push({n:f,l:i,i:h});f=e;i=k;h=0}}}}if(!l.length){break}d=l.pop();f=d.n;i=d.l;
h=d.i}g.push({i:m});this.textmap=g;this.textLength=m;this.spans=[];this.base64Digits="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";
this.tokenToSpans=function(){var r=c.location.hash||"",t;t=r.match(/^#efm(([\-\w]{6}){1,})/);
if(!t||!t.length){return}r=t[1];this.spans=[];var s=this.base64Digits,q,v,u,o,p;for(q=0,v=r.length;
q<v;q+=6){p=r.substr(q,6);u=(s.indexOf(p.charAt(0))<<12)+(s.indexOf(p.charAt(1))<<6)+s.indexOf(p.charAt(2));
o=(s.indexOf(p.charAt(3))<<12)+(s.indexOf(p.charAt(4))<<6)+s.indexOf(p.charAt(5));
this.addSpan(u,o)}};this.spansToToken=function(){var u=this.spans.length;if(!u){return"#efm"
}var s=this.base64Digits,q=["#efm"],p,r,t,o;for(p=0;p<u;p++){r=this.spans[p];t=r.start;
o=r.end;q.push(String(s[t>>12&63])+String(s[t>>6&63])+String(s[t&63]));q.push(String(s[o>>12&63])+String(s[o>>6&63])+String(s[o&63]))
}return q.join("")};this.addSpan=function(o,q){if(o>q){var r=o;o=q;q=r}o=Math.max(0,o);
q=Math.min(this.textLength,q);if(o===q){return}var u=this.spans,p=u.length,s,v,t=0,w=p;
while(t<w){s=t+w>>1;if(q<u[s].start){w=s}else{if(o>u[s].end){t=s+1}else{w=s}}}while(w<p){v=u[w];
if(v.start>q){break}o=Math.min(v.start,o);q=Math.max(v.end,q);w++}u.splice(t,w-t,{start:o,end:q})
};this.removeSpans=function(o,q){if(o>q){var r=o;o=q;q=r}o=Math.max(0,o);q=Math.min(this.textLength,q);
if(o===q){return}var u=this.spans,p=u.length,s,w,t=0,x=p;while(t<x){s=t+x>>1;if(q<=u[s].start){x=s
}else{if(o>=u[s].end){t=s+1}else{x=s}}}var y,v;while(x<p){w=u[x];if(w.start>q){break
}y=Math.max(w.start,o);v=Math.min(w.end,q);if(y>w.start&&v<w.end){u.splice(x+1,0,{start:v,end:w.end});
w.end=y;x+=2;p++}else{if(y===w.start&&v<w.end){w.start=v;x++}else{if(y>w.start&&v===w.end){w.end=y;
x++}else{u.splice(x,1);p--}}}}};this.unhighlightAll=function(o){this.spans=[];if(o){if(c.getSelection){var n=c.getSelection();
if(n){c.getSelection().removeAllRanges()}}this.syncDOMAll()}};this.spanInSpan=function(r,n){var p=this.spans,o=p.length,q;
while(o-->0){q=p[o];if(r>=q.start&&n<=q.end){return true}}return false};this.hasSpans=function(){return this.spans.length>0
};this.highlightSelection=function(r){if(!c.getSelection){return}var q=c.getSelection();
if(!q){return}var p,o,n,s;for(p=0;p<q.rangeCount;p++){o=q.getRangeAt(p);n=this.normalizeOffset(o.startContainer,o.startOffset);
s=this.normalizeOffset(o.endContainer,o.endOffset);if(n>=0&&n<s){this.addSpan(n,s)
}}if(r){q.removeAllRanges();this.syncDOMAll()}};this.unhighlightSelection=function(r){if(!c.getSelection){return
}var q=c.getSelection();if(!q){return}var p,o,n,s;for(p=0;p<q.rangeCount;p++){o=q.getRangeAt(p);
n=this.normalizeOffset(o.startContainer,o.startOffset);s=this.normalizeOffset(o.endContainer,o.endOffset);
if(n>=0&&n<s){this.removeSpans(n,s)}}if(r){q.removeAllRanges();this.syncDOMAll()}};
this.interpretSelection=function(r){if(!c.getSelection){return}var q=c.getSelection();
if(!q){return}var p,o,n,s;for(p=0;p<q.rangeCount;p++){o=q.getRangeAt(p);n=this.normalizeOffset(o.startContainer,o.startOffset);
s=this.normalizeOffset(o.endContainer,o.endOffset);if(n>=0&&n<s){if(this.spanInSpan(n,s)){this.removeSpans(n,s)
}else{this.addSpan(n,s)}}}if(r){q.removeAllRanges();this.syncDOMAll()}};this.syncDOMAll=function(){this.syncDOMHighlights();
this.syncDOMHash();this.syncDOMMenu()};this.syncDOMHighlights=function(){this.unrender();
this.render()};this.syncDOMHash=function(){var n=this.spansToToken();c.location.hash=n
};this.syncDOMGotoFirstAnchor=function(){if(this.hasSpans()){var n=b.querySelector(".efm-parent");
if(n){var o=this.spansToToken();n.id=o.substr(1);c.location.hash="#efm";c.location.hash=o
}}};this.syncDOMMenu=function(){var u=b.getElementById("efm-permalink"),q=c.location.href,s=this.spansToToken();
if(u){u.innerHTML=s?"Permalink with highlights:<br>"+q.replace(/^(.{3,15}).+?(.{3,15})$/,"$1<i>...</i>$2"):"Permalink: [no highlights]";
u.href=q}u=b.getElementById("efm-twitter-button");if(u){var r=[];r.push("url="+String(encodeURIComponent(q)));
r.push("text="+encodeURIComponent(b.querySelector("head title").innerHTML));var t=b.querySelector('head link[rel="canonical"]');
if(t){r.push("counturl="+String(encodeURIComponent(t.href)))}u.href="https://twitter.com/share?"+r.join("&")
}var p=b.querySelectorAll(".efm-need-highlight"),v=p.length,o=this.hasSpans();while(v--){p[v].style.display=o?"":"none"
}};this.unrender=function(){var o=this.textmap,n=o.length-1,q,r,p;while(n-->0){q=o[n];
r=q.n.parentNode;if(r&&r.className&&r.className==="efm-hi"){r.parentNode.replaceChild(q.n,r)
}}n=o.length-1;while(n-->0){q=o[n];p=q.n.parentNode;if(r&&r.className&&p.className==="efm-parent"){while(p.hasChildNodes()){p.parentNode.insertBefore(p.firstChild,p)
}p.parentNode.removeChild(p)}}};this.render=function(){var o=this.spans,n=o.length,p;
while(n-->0){p=o[n];this.renderSpan(p.start,p.end)}};this.renderSpan=function(C,r){var p=this.textmap,s,u,B,z,A,n,v,t,x,q,y,o,w;
u=0;B=p.length;while(u<B){s=u+B>>1;if(C<p[s].i){B=s}else{if(C>=p[s+1].i){u=s+1}else{u=B=s
}}}z=u;B=p.length;while(z<B){A=p[z];n=A.i;v=A.n.nodeValue;x=C-n;q=Math.min(r,p[z+1].i)-n;
p.splice(z,1);y=b.createElement("span");y.className="efm-parent";if(x>0){w=b.createTextNode(v.substring(0,x));
y.appendChild(w);p.splice(z,0,{i:n,n:w});n+=w.length;z++}o=b.createElement("span");
w=b.createTextNode(v.substring(x,q));o.appendChild(w);o.className="efm-hi";y.appendChild(o);
p.splice(z,0,{i:n,n:w});n+=w.length;z++;if(q<v.length){w=b.createTextNode(v.substr(q));
y.appendChild(w);p.splice(z,0,{i:n,n:w});n+=w.length;z++}A.n.parentNode.replaceChild(y,A.n);
if(r<=p[z].i){break}}};this.getTextNodes=function(){};this.normalizeOffset=function(s,r){if(s.nodeType!==3){return -1
}var p=s;while(p){p=p.parentNode;if(p===this.parentNode){break}}if(!p){return -1}var n=this.textmap,q=n.length,o;
while(q-->0){o=n[q];if(s===o.n){return o.i+r}}return -1}};c.addEventListener("load",function(){var h=new a();
if(!h){return}h.tokenToSpans();var g=b.querySelector(".efm-button-container");if(!g){g=b.createElement("div");
g.className="efm-button-container";g.style.position="fixed";g.style.right="0";g.style.bottom="0";
b.body.appendChild(g)}var i=b.createElement("div");i.id="efm-button";i.innerHTML='<div id="efm-menu"><h3 style="margin:0 0 2px 0">EFatMarker</h3><p class="efm-menu-separator efm-need-highlight"></p><a id="efm-permalink" class="efm-need-highlight" href="#" target="_blank"></a><p class="efm-menu-separator efm-need-highlight"></p><a id="efm-twitter-button" class="efm-need-highlight" href="#" target="_blank">these highlights</a><p class="efm-menu-separator"></p><a id="efm-unhighlightall" class="efm-need-highlight">Un-highlight all</a><a id="efm-unhighlight">Un-highlight selection<span>u</span></a><a id="efm-highlight">Highlight selection<span>h</span></a></div>';
g.appendChild(i);i.addEventListener("mousedown",function(j){h.interpretSelection(true);
j.preventDefault()});var f=b.querySelector("#efm-unhighlightall");if(f){f.addEventListener("mousedown",function(j){h.unhighlightAll(true);
j.preventDefault()})}f=b.querySelector("#efm-unhighlight");if(f){f.addEventListener("mousedown",function(j){h.unhighlightSelection(true);
j.preventDefault()})}f=b.querySelector("#efm-highlight");if(f){f.addEventListener("mousedown",function(j){h.highlightSelection(true);
j.preventDefault()})}h.syncDOMHighlights();h.syncDOMMenu();if(h.hasSpans()){if(typeof jQuery==="function"){jQuery("body,html").animate({scrollTop:parseInt(jQuery(".efm-parent").offset().top,10)})
}else{if(typeof Fx==="function"){var e=b.querySelector(".efm-parent");if(e){var d=new Fx.Scroll(c,{offset:{x:0,y:-50}});
d.toElement(e)}}else{h.syncDOMGotoFirstAnchor()}}}})}());
